<%=# f.grouped_collection_select :batch_id, Product.order(:rkproductname), :batches, :rkproductname, :id, :rkbatchno, include_blank: true %>

<%= observe_field :product_id, :url => batches_path(:format => "for_select"), :method => :get, :update => :purchproditemvat_batch_id, :with => "'product_id=' + value" %>

<%= f.collection_select :product_id, Product.order(:rkproductname), :id, :rkproductname, include_blank: true %>

<%= f.select :product_id, options_for_select(@products.collect { |product|
    [product.rkproductname.titleize, product.id] }, 1), {}, { id: 'products_select' } %>

    <option value="<%= batch.rkbatchpacking %>"><%= batch.rkbatchpacking.titleize %></option>
<%= f.select :rkpurchproduom, options_for_select(@batches.collect { |batch| [batch.rkbatchpacking.titleize, batch.rkbatchpacking] }, 0), {}, { id: 'batches_select' } %>

<%= f.select :batch_id, options_for_select(@batches.collect { |batch| [batch.rkbatchno.titleize, batch.id] }, 0), {}, { id: 'batches_select' } %>
<%= f.select(:rkpurchprobatch,{},{}, { :class => 'form-control batch' }) %>
<option value="<%= batch.id %>"><%= batch.rkbatchno.titleize %></option>
<%= f.select(:rkpurchprobatch,{selected: :rkpurchprobatch},{}, { :class => 'form-control batch' }) %>

# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/
$ ->
  $(document).on 'change', '.product', (evt) ->
    $.ajax '/productpurchasevats/update_batches',
      type: 'GET'
      dataType: 'script'
      data: {
        product_id: $(".product option:selected").val()
      }
      error: (jqXHR, textStatus, errorThrown) ->
        console.log("AJAX Error: #{textStatus}")
      success: (data, textStatus, jqXHR) ->
        #item = JSON.parse(data)

        console.log(data)
        console.log("Dynamic product select OK!")





    /**
     * Calculate Autopopulate value on Selection.
     *
     * @returns {number}
     */

    changeVal: function() {
        jQuery($.opt.parentClass).each(function() {
            var row = jQuery(this);
            $.ajax('/productpurchasevats/update_batches', {
                type: 'GET',
                dataType: 'script',
                data: {
                    product_id: row.find(".product option:selected").val()

            }, error : function(jqXHR, textStatus, errorThrown) {
                return console.log(`AJAX Error: ${textStatus}`);
            }, success : function(data) {
              //console.log(data);
              data = JSON.parse(data).map(function(i) {
                console.log(i.rkbatchno);
                row.find($.opt.batch).append('<option value="'+i.rkbatchno+'">'+i.rkbatchno+'</option>');
                row.find($.opt.uom).empty().append('<option value="'+i.rkbatchpacking+'">'+i.rkbatchpacking+'</option>');
                row.find($.opt.exp).empty().append('<option value="'+i.rkbatchexpiry+'">'+i.rkbatchexpiry+'</option>');
                row.find($.opt.price).empty().append('<option value="'+i.rkbatchpurchaserate+'">'+i.rkbatchpurchaserate+'</option>');
              });
             }
            });
        });
        return 1;
    },
